# @configure_input@

# Package
package      := @PACKAGE_NAME@
version      := @PACKAGE_VERSION@
tarname      := @PACKAGE_TARNAME@

# Directories
prefix       := @prefix@
exec_prefix  := @exec_prefix@
bindir       := @bindir@
libdir       := @libdir@
includedir   := @includedir@
srcdir       := src
testdir      := test
builddir     := build
srcmods      := $(srcdir)/ \
                ${filter %/,${wildcard $(srcdir)/*/}} \
                ${filter %/,${wildcard $(srcdir)/*/*/}}
testmods     := $(testdir)/ \
                ${filter %/,${wildcard $(testdir)/*/}} \
                ${filter %/,${wildcard $(testdir)/*/*/}}
VPATH        := $(srcdir) $(testdir) $(builddir) $(srcmods) $(testmods)

# Tools
CXX          := @CXX@
INCLUDES     := -I./ -I$(srcdir)/ ${addprefix -I,$(srcmods)}
DEFS         := @DEFS@
CXXFLAGS     := @CXXFLAGS@ $(DEFS) -fPIC $(INCLUDES)
LIBS         := @LIBS@
LDFLAGS      := @LDFLAGS@
INSTALL      := @INSTALL@

# Files
sources      := ${foreach m,$(srcmods),${wildcard $(m)*.cpp}}
headers      := ${subst .cpp,.hpp,$(sources)}
objects      := ${notdir ${subst .cpp,.o,$(sources)}}
fixtures     := ${foreach m,$(testmods),${wildcard $(m)*.cxx}}
tests        := ${notdir ${subst .cxx,,$(fixtures)}}
depends      := ${subst .o,.d,$(objects)} ${addsuffix .d,$(tests)}

# Interface
.PHONY: all clean distclean
.DEFAULT: all
all: objects tests
clean:
	@echo "  RM    build"
	@$(RM) -r $(builddir)
distclean:
	@echo "  RM    autoscan files"
	@$(RM) autoscan.log
	@$(RM) configure.scan
	@echo "  RM    configure files"
	@$(RM) aclocal.m4
	@$(RM) -r autom4te.cache
	@$(RM) config.h
	@$(RM) config.log
	@$(RM) config.status
	@$(RM) config.sub
	@$(RM) Makefile

# Objects
.PHONY: objects
objects: $(objects)
%.o: %.cpp %.hpp
	@echo "  CXX   $@"
	@$(CXX) \
            $(CXXFLAGS) \
            -c $< -o $(builddir)/$@

# Tests
.PHONY: tests
tests: $(tests)
%: %.cxx
	@echo "  CXX   $@"
	@$(CXX) \
            $(CXXFLAGS) $(LDFLAGS) \
            $< -o $(builddir)/$@ \
            ${addprefix build/,${notdir ${filter %.o,$^}}} \
            $(LIBS)

# Dependencies
.PHONY: depends
depends: $(depends)
$(builddir)/%.d: %.hpp
	@echo "  GEN   $@"
	@$(INSTALL) -d $(builddir)
	@$(CXX) \
            $(CXXFLAGS) \
            -MM $< \
            > $@
$(builddir)/%.d: %.cxx
	@echo "  GEN   $@"
	@$(INSTALL) -d $(builddir)
	@$(CXX) \
            $(CXXFLAGS) \
            -MM $< \
            | sed 's|\.o||' \
            | sed 's|\.hpp|\.o|g' \
            | sed 's|[[:alnum:]/]*/||g' \
            > $@
ifneq ($(MAKECMDGOALS),clean)
  -include ${addprefix $(builddir)/,$(depends)}
endif
