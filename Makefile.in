# @configure_input@

# Package
package      := @PACKAGE_NAME@
version      := @PACKAGE_VERSION@
tarname      := @PACKAGE_TARNAME@

# Directories
prefix       := @prefix@
exec_prefix  := @exec_prefix@
bindir       := @bindir@
srcdir       := src
testdir      := test
libdir       := @libdir@
includedir   := @includedir@
VPATH        := $(srcdir) $(testdir)

# Tools
CXX          := @CXX@
INCLUDES     := -I./ -I$(srcdir)/
DEFS         := @DEFS@
CXXFLAGS     := @CXXFLAGS@ $(DEFS) -fPIC $(INCLUDES)
LIBS         := @LIBS@
LDFLAGS      := @LDFLAGS@
INSTALL      := @INSTALL@

# Files
sources      := ${wildcard $(srcdir)/*.cpp}
headers      := ${subst .cpp,.hpp,$(sources)}
objects      := ${subst .cpp,.o,$(sources)}
harnesses    := ${wildcard $(testdir)/*.cxx}
tests        := ${subst .cxx,,$(harnesses)}
depends      := ${subst .hpp,.d,$(headers)} ${subst .cxx,.d,$(harnesses)}

# Interface
.PHONY: all clean
.DEFAULT: all
all: objects tests
clean:
	@echo "  RM  objects"
	@$(RM) $(objects)
	@echo "  RM  tests"
	@$(RM) $(tests)
	@echo "  RM  dependencies"
	@$(RM) $(depends)
distclean:
	@echo "  RM  autoscan files"
	@$(RM) autoscan.log
	@$(RM) configure.scan
	@echo "  RM  configure files"
	@$(RM) aclocal.m4
	@$(RM) -r autom4te.cache
	@$(RM) config.h
	@$(RM) config.log
	@$(RM) config.status
	@$(RM) config.sub
	@$(RM) Makefile

# Objects
.PHONY: objects
objects: ${notdir $(objects)}
%.o: %.cpp %.hpp
	@echo "  CXX $@"
	@$(CXX) -c $(CXXFLAGS) $< -o $@

# Tests
.PHONY: tests
tests: ${notdir $(tests)}
%: %.cxx
	@echo "  CXX $@"
	@$(CXX) $(CXXFLAGS) $(LDFLAGS) $^ -o $(testdir)/$@ $(LIBS)

# Dependencies
.PHONY: depends
depends: $(depends)
%.d: %.hpp
	@echo "  GEN $@"
	@$(CXX) $(CXXFLAGS) -MM $< > $@
%.d: %.cxx
	@echo "  GEN $@"
	@$(CXX) $(CXXFLAGS) -MM $< | sed 's/\.o//;s/\.hpp/\.o/g' > $@
ifneq ($(MAKECMDGOALS),clean)
  -include $(depends)
endif

